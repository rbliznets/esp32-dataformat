# Команды для работы с файловой системой
В корне json должен быть только один элемент __"spiffs"__. Корень json может содержать другие элементы. 
Одновременно передаётся только одна команда, следующая только после получения ответа.
При возникновении ошибки при обработке команды выдаётся следующий ответ:
```
{
    "spiffs":
    {
        "error":"описание ошибки"
    }
}
```
### 1.Получить список файлов.
```
{
    "spiffs":
    {
        "ls":null
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "files":
        [
            {
                "name":"Figure_cc1.png",    //имя файла
                "size":53166                //размер файла в байтах
            },
            {
                "name":"udp.json",
                "size":170}
        ]
    }
}
```
### 2.Прочитать данные из файла.
```
{
    "spiffs":
    {
        "rd":"udp.json",    //имя файла
        "offset":0,"        //смещение в файле
        size":88            //размер запрашиваемого пакета данных 
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fr":"udp.json",    //имя файла
        "offset":0,         //смещение в файле
        "data":"7b0a2020202022756470223a207b0a20202020202020202273736964223a20225265646d695f39343330222c0a20202020202020202270617373776f7264223a2022466f7874726f7431222c0a2020202020202020226465" //данные
    }
}
```
### 3.Записать данные в файл.
```
{
    "spiffs":
    {
        "wr":"test.txt$",    //имя файла
        "offset":0,          //смещение в файле
        "data":"0D0A73746174696320696E6C696E6520696E7433325F74206D656C70655F4C5F61646428726567697374657220696E7433325F74204C5F766172312C20726567697374657220696E7433325F74204C5F76617232290D0A7B" //данные
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fw":"test.txt$",   //имя файла
        "offset":0,         //смещение в файле
        "size":88           //размер записанных данных 
    }
}
```
Данные должны записываться последовательно, т.е. смещение следующего пакета данных должно быть равно offset+size ответа. Первый пакет должен иметь нулевое смещение.
### 4.Переименовать файл.
```
{
    "spiffs":
    {
        "old":"test.txt$",  //старое имя файла
        "new":"test.txt!"   //новое имя файла
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fold":"test.txt$", //старое имя файла
        "fnew":"test.txt!"  //новое имя файла
    }
}
```
### 5.Удалить файл.
```
{
    "spiffs":
    {
        "rm":"test.txt" //имя файла
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fd":"test.txt" //имя файла
    }
}
```
## Транзакция записи файла.
Для гарантированной записи данных в файл осуществляются следующие действия:
1. К имени файла добавляется '$' и он последовательно записывается в устройство.
2. После записи всех данных файл переименовывается из <имя_файла>$ в <имя_файла>!
3. Удаляется старый файл
4. Файл переименовывается из <имя_файла>! в <имя_файла>
Если по какой-то причине транзакция прервалась, то она отменится или завершится при следующем старте устройства.
## Ограничения   
1. Имена файлов не должны заканчиваться на $ и !
2. Длина имени файла не больше заданного в настройках sdkconfig (по умолчанию 30)
### Настройки sdkconfig
```
#
# SPIFFS Configuration
#
CONFIG_SPIFFS_MAX_PARTITIONS=1

#
# SPIFFS Cache Configuration
#
CONFIG_SPIFFS_CACHE=y
CONFIG_SPIFFS_CACHE_WR=y
# CONFIG_SPIFFS_CACHE_STATS is not set
# end of SPIFFS Cache Configuration

CONFIG_SPIFFS_PAGE_CHECK=y
CONFIG_SPIFFS_GC_MAX_RUNS=10
# CONFIG_SPIFFS_GC_STATS is not set
CONFIG_SPIFFS_PAGE_SIZE=256
CONFIG_SPIFFS_OBJ_NAME_LEN=32
# CONFIG_SPIFFS_FOLLOW_SYMLINKS is not set
CONFIG_SPIFFS_USE_MAGIC=y
CONFIG_SPIFFS_USE_MAGIC_LENGTH=y
CONFIG_SPIFFS_META_LENGTH=4
# CONFIG_SPIFFS_USE_MTIME is not set
```
