# Команды для работы с файловой системой
В корне json должен быть только один элемент __"spiffs"__. Корень json может содержать другие элементы. 
Одновременно передаётся только одна команда, следующая только после получения ответа.
При возникновении ошибки при обработке команды выдаётся следующий ответ:
```
{
    "spiffs":
    {
        "error":"описание ошибки"
    }
}
```
### 1.Получить список файлов.
```
{
    "spiffs":
    {
        "ls":"",    //путь к директории, "" - корневая
        "offset":0, //смещение в списке файлов (опция для большого количества файлов)
        "count":10 //максимальное количество выдаваемого списка файлов (опция для большого количества файлов)
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "root":"", //путь к директории, "" - корневая
        "files":
        [
            {
                "name":"Figure_cc1.png",        //имя файла
                "size":53166,                   //размер файла в байтах
                "modify":"1970.01.01 00:00:00"  //время модификации файла, если поддерживается файловой системой 
            },
            {
                "name":"udp.json",
                "size":170
            },
            {
                "name":"s", //если размера нет, то имя директории
                "count:10  //количество файлов в директории
            }
       ]
    }
}
```
### 2.Прочитать данные из файла.
```
{
    "spiffs":
    {
        "rd":"udp.json",    //имя файла
        "offset":0,         //смещение в файле (по умолчанию 0)
        "size":88           //размер запрашиваемого пакета данных (по умолчанию DATAFORMAT_DEFAULT_DATA_SIZE/2)
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fr":"udp.json",    //имя файла
        "offset":0,         //смещение в файле (по умолчанию 0)
        "data":"7b0a2020202022756470223a207b0a20202020202020202273736964223a20225265646d695f39343330222c0a20202020202020202270617373776f7264223a2022466f7874726f7431222c0a2020202020202020226465" //данные
    }
}
```
### 3.Записать данные в файл.
```
{
    "spiffs":
    {
        "wr":"test.txt$",    //имя файла
        "offset":0,          //смещение в файле (по умолчанию 0)
        "data":"0D0A73746174696320696E6C696E6520696E7433325F74206D656C70655F4C5F61646428726567697374657220696E7433325F74204C5F766172312C20726567697374657220696E7433325F74204C5F76617232290D0A7B" //данные
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fw":"test.txt$",   //имя файла
        "offset":0,         //смещение в файле (по умолчанию 0)
        "size":88           //размер записанных данных 
    }
}
```
Данные должны записываться последовательно, т.е. смещение следующего пакета данных должно быть равно offset+size ответа. Первый пакет должен иметь нулевое смещение.
### 4.Записать текст в файл.
Создать новый файл:
```
{
    "spiffs":
    {
        "ct":"test.txt",        //имя файла
        "text":"{\"field\":10}" //данные
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "tc":"test.txt",    //имя файла
        "size":12           //размер файла
    }
}
```
Добавить текст в конец файла:
```
{
    "spiffs":
    {
        "at":"test.txt",        //имя файла
        "text":"{\"field\":10}" //данные
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "at":"test.txt",    //имя файла
        "size":24           //размер файла
    }
}
```
### 5.Прочитать текст из файла.
```
{
    "spiffs":
    {
        "rt":"test.txt",    //имя файла
        "offset":12,        //смещение в файле (по умолчанию 0)
        "size":64           //размер запрашиваемого пакета данных (по умолчанию DATAFORMAT_DEFAULT_DATA_SIZE)
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "tr":"test.txt",        //имя файла
        "offset":12,            //смещение в файле (по умолчанию 0)
        "text":"{\"field\":10}" //данные
    }
}
```

### 6.Переименовать файл.
```
{
    "spiffs":
    {
        "old":"test.txt$",  //старое имя файла
        "new":"test.txt!"   //новое имя файла
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fold":"test.txt$", //старое имя файла
        "fnew":"test.txt!"  //новое имя файла
    }
}
```
### 7.Удалить файл.
```
{
    "spiffs":
    {
        "rm":"test.txt" //имя файла
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "fd":"test.txt" //имя файла
    }
}
```
## Транзакция записи файла.
Для гарантированной записи данных в файл осуществляются следующие действия:
1. К имени файла добавляется '$' и он последовательно записывается в устройство.
2. После записи всех данных файл переименовывается из <имя_файла>$ в <имя_файла>!
3. Удаляется старый файл
4. Файл переименовывается из <имя_файла>! в <имя_файла>
Если по какой-то причине транзакция прервалась, то она отменится или завершится при следующем старте устройства.

Для группы файлов выполняется 1 шаг для всех файлов и затем шаги 2..4 можно выполнить следующей командой:
```
{
    "spiffs":
    {
        "trans":"end" 
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "trans":"end"
    }
}
```
Или отменить командой:
```
{
    "spiffs":
    {
        "trans":"cancel" 
    }
}
```
Ответ
```
{
    "spiffs":
    {
        "trans":"cancel"
    }
}
```
## Ограничения   
1. Имена файлов не должны заканчиваться на $ и !
2. Длина имени файла не больше заданного в настройках sdkconfig (по умолчанию 30)
### Настройки sdkconfig
```
#
# SPIFFS Configuration
#
CONFIG_SPIFFS_MAX_PARTITIONS=1

#
# SPIFFS Cache Configuration
#
CONFIG_SPIFFS_CACHE=y
CONFIG_SPIFFS_CACHE_WR=y
# CONFIG_SPIFFS_CACHE_STATS is not set
# end of SPIFFS Cache Configuration

CONFIG_SPIFFS_PAGE_CHECK=y
CONFIG_SPIFFS_GC_MAX_RUNS=10
# CONFIG_SPIFFS_GC_STATS is not set
CONFIG_SPIFFS_PAGE_SIZE=256
CONFIG_SPIFFS_OBJ_NAME_LEN=32
# CONFIG_SPIFFS_FOLLOW_SYMLINKS is not set
CONFIG_SPIFFS_USE_MAGIC=y
CONFIG_SPIFFS_USE_MAGIC_LENGTH=y
CONFIG_SPIFFS_META_LENGTH=4
# CONFIG_SPIFFS_USE_MTIME is not set
```
