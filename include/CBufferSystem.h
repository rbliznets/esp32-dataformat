/*!
	\file
	\brief Класс для работы с буфером PSRAM.
	\authors Близнец Р.А. (r.bliznets@gmail.com)
	\version 1.2.0.0
	\date 21.02.2024
*/

#pragma once

#include "sdkconfig.h"

#include <nlohmann/json.hpp>
using json = nlohmann::json;

#define BUF_PART_SIZE (200) ///< Размер части буфера по умолчанию в байтах

/// @brief Класс для работы с буфером PSRAM с возможностью почастного заполнения.
class CBufferSystem
{
protected:
	uint8_t *mBuffer = nullptr;		///< Указатель на буфер данных в памяти
	uint32_t mSize;					///< Общий размер буфера в байтах
	uint16_t mPart = BUF_PART_SIZE; ///< Размер каждой части буфера в байтах
	uint8_t *mParts = nullptr;		///< Массив флагов состояния частей (0 - пустая, 1 - заполненная)
	uint16_t mLastPart;				///< Индекс последней части в массиве (нумерация с 0)
	bool mRead = false;				///< Флаг, указывающий что буфер загружен из файла и готов к чтению

	/**
		@fn CBufferSystem::init(uint32_t size)
		@brief Инициализирует буфер заданного размера в PSRAM или обычной памяти.
		@param size Размер буфера в байтах для выделения памяти.
		@return Возвращает true если инициализация прошла успешно, false в случае ошибки выделения памяти.
	*/
	bool init(uint32_t size);

	/**
	@fn CBufferSystem::free()
	@brief Освобождает выделенную память буфера и сбрасывает все свойства класса.
	*/
	void free();

public:
	/// @brief Деструктор класса CBufferSystem. Автоматически освобождает память буфера.
	~CBufferSystem()
	{
		free();
	};

	/// Обработка JSON-команд для управления буфером.
	/*!
	  \param[in] cmd JSON-объект с командами в корне (содержит ключ "buf").
	  \param[out] answer JSON-объект с ответом на команду.
	  \param[out] cancel Флаг отмены операции (устанавливается в true для команды "cancel").
	  
	  Поддерживаемые команды:
	  - "create": создание буфера заданного размера
	  - "check": проверка состояния буфера и списка незаполненных частей
	  - "wr": запись буфера в файл
	  - "ota": выполнение OTA-обновления из буфера
	  - "rd": чтение буфера из файла
	  - "free": освобождение буфера
	  - "cancel": отмена операции с освобождением буфера
	*/
	void command(json& cmd, json& answer, bool &cancel);

	/// Добавление данных в буфер по частям.
	/*!
	  \param[in] data Указатель на данные (первые 2 байта содержат номер части, остальные - данные).
	  \param[in] size Размер данных в байтах (включая 2 байта номера части).
	  
	  Данные добавляются в буфер в соответствии с номером части, указанной в первых двух байтах.
	  Каждая часть помечается как заполненная в массиве mParts.
	*/
	void addData(uint8_t *data, uint32_t size);

	/// Получение данных из буфера по частям для последовательного чтения.
	/*!
	  \param[out] size Размер полученных данных в байтах.
	  \param[out] index Номер части, из которой получены данные.
	  \return Указатель на данные или nullptr если все части уже прочитаны или буфер не загружен.
	  
	  Функция возвращает указатель на следующую непрочитанную часть буфера и помечает её как прочитанную.
	  После чтения все части будут последовательно возвращены, после чего функция вернёт nullptr.
	*/
	uint8_t *getData(uint32_t &size, uint16_t &index);
};