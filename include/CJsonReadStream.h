/*!
    \file
    \brief Класс для обнаружения json строки из потока байтов.
    \authors Близнец Р.А. (r.bliznets@gmail.com)
    \version 1.0.0.0
    \date 18.04.2022
*/

#pragma once
#include "sdkconfig.h"

#include <string>
#include <cstring>
#include <list>

/// Класс для обнаружения и извлечения JSON строк из потока байтов.
/*!
  Класс анализирует поток байтов, отслеживает баланс фигурных скобок { и }
  для выделения полных JSON объектов. Поддерживает обработку фрагментированных данных
  и накопление неполных объектов во временный буфер.
*/
class CJsonReadStream
{
protected:
  uint8_t *mBuf = nullptr; ///< Буфер для хранения неполных JSON объектов между вызовами
  uint16_t mBufIndex;      ///< Текущий индекс (размер) данных в буфере
  uint16_t mSize;          ///< Максимальный размер буфера для неполных объектов
  bool mFree;              ///< Флаг автоматического освобождения памяти буфера

  uint16_t mCount = 0;             ///< Счетчик непарных открывающих скобок { (баланс скобок)
  std::list<std::string> mStrings; ///< Очередь найденных и полных JSON строк

public:
  /// Конструктор класса.
  /*!
    \param[in] max_size Максимальный размер буфера для хранения неполных JSON объектов
    \param[in] auto_free Флаг автоматического освобождения памяти буфера (по умолчанию true)
  */
  CJsonReadStream(uint16_t max_size, bool auto_free = true);
  
  /// Деструктор класса.
  /*!
    Освобождает память буфера и очищает список найденных JSON строк.
  */
  ~CJsonReadStream();

  /// Очистить буфер и освободить память.
  /*!
    Принудительно освобождает память временного буфера и сбрасывает состояние класса.
  */
  void free();
  
  /// Добавить данные для обработки и поиска JSON объектов.
  /*!
    Анализирует поток байтов, отслеживает баланс фигурных скобок и выделяет полные JSON объекты.
    Неполные объекты сохраняются во временный буфер для последующей обработки.
    
    \param[in] data Указатель на массив байтов для анализа
    \param[in] size Размер данных в байтах
    \return true если есть незавершенные JSON объекты (ожидаются еще данные), false если все объекты завершены
  */
  bool add(uint8_t *data, uint16_t size);
  
  /// Получить следующую найденную JSON строку.
  /*!
    Извлекает первую найденную JSON строку из очереди и удаляет её из списка.
    
    \param[out] str Ссылка на строку, куда будет записана найденная JSON строка
    \return true если строка успешно получена, false если очередь пуста
  */
  bool get(std::string &str);
};