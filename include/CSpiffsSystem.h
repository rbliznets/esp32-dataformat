/*!
    \file
    \brief Класс для работы с SPIFFS.
    \authors Близнец Р.А. (r.bliznets@gmail.com)
    \version 1.4.0.0
    \date 12.12.2023
*/

#pragma once

#include "sdkconfig.h"

#include "freertos/FreeRTOS.h"
#include "freertos/semphr.h"
#include <list>

#include <nlohmann/json.hpp>
using json = nlohmann::json;

/// Тип функции обратного вызова для уведомления о событиях работы с SPIFFS
/// @param lock true - начало транзакции (запись), false - окончание транзакции
typedef void onSpiffsWork(bool lock);

/// Статический класс для работы с файловой системой SPIFFS.
/*!
  Предоставляет функции для инициализации, управления файлами и транзакциями SPIFFS.
  Поддерживает регистрацию callback-функций для уведомления о состоянии файловой системы.
  Реализует атомарные операции ввода-вывода и управление транзакциями.
*/
class CSpiffsSystem
{
protected:
    /// Очередь обработчиков событий работы с SPIFFS
    /// Используется для уведомления внешних модулей о начале/окончании операций записи
    static std::list<onSpiffsWork *> mWriteQueue;

    /// Внутренний метод для генерации событий работы с файловой системой
    /// @param lock true - начало транзакции (запись), false - окончание транзакции
    static void writeEvent(bool lock);

public:
    /*!
     * @brief Инициализация файловой системы SPIFFS
     * @param check Флаг проверки целостности файловой системы (по умолчанию false)
     * @return true - если инициализация прошла успешно, иначе false
     *
     * Выполняет регистрацию SPIFFS в VFS, проверку целостности (при check=true)
     * и получение информации о разделе. При необходимости выполняет форматирование.
     *
     * \note При check=true может вызвать таймаут Watchdog из-за длительной операции
     * \warning Форматирование приведет к потере всех данных в файловой системе
     */
    static bool init(bool check = false);

    /*!
     * @brief Освобождение ресурсов файловой системы
     *
     * Выполняет деинициализацию SPIFFS, отменяет регистрацию в VFS
     * и освобождает связанные ресурсы.
     *
     * \note После вызова этого метода доступ к SPIFFS невозможен
     * \warning Необходимо убедиться, что все файлы закрыты перед вызовом
     */
    static void free();

    /*!
     * @brief Проверка и завершение незавершенных транзакций
     * @return true - если все транзакции завершены успешно, иначе false
     *
     * Обрабатывает специальные файлы транзакций (*.tmp, *.bak) и завершает
     * незавершенные операции ввода-вывода для обеспечения целостности данных.
     *
     * \note Используется для гарантии завершения операций ввода-вывода перед выходом
     * \warning Метод модифицирует файловую систему
     */
    static bool endTransaction();

    /*!
     * @brief Запись буфера данных в файл
     * @param fileName Имя файла для записи (полный путь)
     * @param data Указатель на буфер с данными для записи
     * @param size Размер данных в байтах
     * @return true - если запись прошла успешно, иначе false
     *
     * Выполняет атомарную операцию записи с блокировкой файловой системы.
     * Файл открывается в режиме дозаписи ("a").
     *
     * \note Автоматически уведомляет обработчики о начале/окончании операции
     * \warning Не гарантирует атомарность при сбоях питания
     */
    static bool writeBuffer(const char *fileName, uint8_t *data, uint32_t size);

    /// Обработка JSON-команд работы с SPIFFS.
    /*!
     * @brief Обработка команд JSON для управления файловой системой
     *
     * Поддерживаемые команды:
     * - "ls": Получение списка файлов в директории (с пагинацией)
     * - "rd": Чтение бинарного содержимого файла
     * - "rm": Удаление файла
     * - "trans": Управление транзакциями ("end"/"cancel")
     * - "old"/"new": Переименование файла
     * - "wr": Запись бинарных данных в файл
     * - "ct": Создание текстового файла
     * - "at": Добавление текста в конец файла
     * - "rt": Чтение текстового файла
     *
     * @param cmd JSON-объект с командами работы с SPIFFS (ключ "spiffs" в корне)
     * @param[out] answer JSON-объект с результатами выполнения команд
     *
     * \note Все операции с файлами обёрнуты в механизмы синхронизации
     * \warning Некоторые операции могут быть длительными
     */
    static void command(json &cmd, json &answer);

    /*!
     * @brief Добавление обработчика события работы с SPIFFS
     * @param event Указатель на функцию-обработчик
     *
     * Регистрирует функцию, которая будет вызываться при начале/окончании
     * операций записи в файловую систему. Проверяет уникальность обработчика.
     *
     * \note Обработчик вызывается синхронно в контексте вызывающего потока
     * \warning Необходимо корректно освобождать память обработчика
     */
    static void addWriteEvent(onSpiffsWork *event);

    /*!
     * @brief Удаление обработчика события работы с SPIFFS
     * @param event Указатель на функцию-обработчик
     *
     * Удаляет ранее добавленный обработчик из очереди уведомлений.
     * Безопасно удаляет все дубликаты обработчика.
     *
     * \note Метод гарантирует удаление всех вхождений обработчика
     * \warning После удаления обработчик должен быть корректно освобожден
     */
    static void removeWriteEvent(onSpiffsWork *event);

    /**
     * @brief Очищает содержимое файлов в указанной директории (при окончании транзакции)
     *
     * Функция открывает все файлы в директории и маркирует их для стирания при завершении транзакции.
     * Файлы с расширениями '!' и '$' игнорируются (считаются служебными).
     *
     * @param dirName Путь к директории, содержимое файлов которой нужно очистить
     * @return uint16_t Количество успешно очищенных файлов
     */
    static uint16_t clearDir(const char *dirName);
};