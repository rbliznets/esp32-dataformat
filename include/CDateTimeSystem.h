/*!
	\file
	\brief Класс для синхронизации системного времени.
	\authors Близнец Р.А. (r.bliznets@gmail.com)
	\version 1.2.0.0
	\date 13.09.2024
*/

#pragma once

#include "sdkconfig.h"

#include <nlohmann/json.hpp>
using json = nlohmann::json;

#include <sys/time.h>

/// Статический класс для синхронизации и управления системным временем.
/*!
  Предоставляет функции для установки, сохранения и синхронизации системного времени.
  Поддерживает работу с NVS памятью для сохранения времени между перезагрузками.
*/
class CDateTimeSystem
{
protected:
	static bool mSync; ///< Флаг состояния синхронизации времени (true - время синхронизировано)

public:
	/// Инициализация системного времени при запуске.
	/*!
	  Загружает сохраненное время из NVS памяти и устанавливает системное время.
	  Если данные отсутствуют, используется время по умолчанию.
	*/
	static void init();

	/// @brief Установка системного времени
	/// @param now Время в формате UNIX timestamp (секунды с 1 января 1970 года)
	/// @param force Устанавливать даже если время уже синхронизировано (по умолчанию false)
	/// @param approximate Флаг неточного источника времени, проверяет монотонность (по умолчанию false)
	/// @return true если время установлено успешно, иначе false
	static bool setDateTime(time_t now, bool force = false, bool approximate = false);

	/// @brief Запись текущего системного времени в NVS память
	/// @return true если время успешно записано, иначе false
	static bool saveDateTime();

	/// Обработка JSON-команд синхронизации времени.
	/*!
	  Обрабатывает команды синхронизации времени из JSON объекта.
	  Поддерживаемые команды:
	  - "epoch": установка времени по UNIX timestamp
	  - "force": принудительное сохранение текущего времени
	  - "approximate": приблизительная синхронизация
	  
	  \param[in] cmd JSON-объект с командами синхронизации времени.
	  \param[out] answer JSON-объект с результатами выполнения команд.
	*/
	static void command(json& cmd, json& answer);

	/// @brief Получение флага синхронизации времени
	/// @return true если время синхронизировано, false если нет
	static inline bool isSync() { return mSync; }

	/// @brief Вывод текущей даты и времени в лог
	/*!
	  Форматирует и выводит текущее системное время в формате YYYY-MM-DD HH:MM:SS
	  вместе с состоянием синхронизации времени.
	*/
	static void log();
};